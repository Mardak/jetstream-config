version: 2.1

jobs:
  validate:
    docker:
    - image: gcr.io/moz-fx-data-experiments/pensieve:latest
    steps:
    - checkout
    - run:
        name: Validate config files
        command: echo "TODO validate configs" # todo
  rerun:
    docker:
    - image: google/cloud-sdk
    steps:
    - checkout
    - &skip_forked_pr
      run:
        name: Early return if this build is from a forked PR
        command: |
          if [ -n "$CIRCLE_PR_NUMBER" ]; then
            echo "Do not re-run analysis on forked PRs, so marking this step successful"
            circleci step halt
          fi
    - run:
        name: Authorize gcloud CLI
        command: |
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/gcp.json"
          echo "$GCLOUD_SERVICE_KEY" > "$GOOGLE_APPLICATION_CREDENTIALS"
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project $GCLOUD_PROJECT
          gcloud container clusters get-credentials jetstream --zone us-central1-a --project $GCLOUD_PROJECT
    - run:
        name: Rerun jetstream
        command: |
          kubectl run jetstream --image=gcr.io/moz-fx-data-experiments/pensieve -l app=jetstream --command -- bin/entrypoint rerun
          kubectl logs -l app=jetstream -f
          exitCode=`kubectl get pod -l app=jetstream --output="jsonpath={.items[].status.containerStatuses[].lastState.terminated.exitCode}"`
          if [ "$exitCode" -ge 1 ]; then
            echo "Error when running jetstream"
            circleci step halt
          fi
    - run:
        name: Export data as JSON
        command: |
          kubectl run jetstream-export --image=gcr.io/moz-fx-data-experiments/pensieve -l app=jetstream-export --command -- bin/entrypoint export_data_as_json
          kubectl logs -l app=jetstream-export -f
          exitCode=`kubectl get pod -l app=jetstream-export --output="jsonpath={.items[].status.containerStatuses[].lastState.terminated.exitCode}"`
          if [ "$exitCode" -ge 1 ]; then
            echo "Error when exporting data as JSON"
            circleci step halt
          fi
workflows:
  build-and-deploy:
    jobs:
      - validate
      - rerun
